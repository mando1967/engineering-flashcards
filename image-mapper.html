<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Mapper - QuizWiz</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    select, button {
      padding: 8px 12px;
      font-size: 14px;
      margin-right: 10px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    button.export { background: #28a745; }
    button.export:hover { background: #218838; }
    
    .problem-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .problem-text {
      border-right: 2px solid #ddd;
      padding-right: 20px;
    }
    .problem-text h3 {
      margin-top: 0;
      color: #007bff;
    }
    .problem-text pre {
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
    }
    .image-selector {
      padding-left: 20px;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .image-option {
      border: 3px solid #ddd;
      border-radius: 4px;
      padding: 5px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    .image-option:hover {
      border-color: #007bff;
      transform: scale(1.05);
    }
    .image-option.selected {
      border-color: #28a745;
      background: #e7f5e7;
    }
    .image-option img {
      width: 100%;
      height: auto;
      display: block;
    }
    .image-option .label {
      text-align: center;
      font-size: 12px;
      font-weight: bold;
      margin-top: 5px;
      color: #666;
    }
    .image-option .checkbox {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #28a745;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .image-option.selected .checkbox {
      opacity: 1;
    }
    .image-option {
      position: relative;
    }
    .no-image-option {
      border: 3px dashed #ddd;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      color: #999;
      font-weight: bold;
    }
    .no-image-option:hover {
      border-color: #007bff;
      color: #007bff;
    }
    .no-image-option.selected {
      border-color: #28a745;
      background: #e7f5e7;
      color: #28a745;
    }
    #output {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    #output pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üñºÔ∏è Image Mapper for QuizWiz</h1>
  
  <div class="controls">
    <label>Select Subject: </label>
    <select id="subjectSelect" onchange="updateTestSets()">
    </select>
    <label>Select Test Set: </label>
    <select id="testSetSelect" onchange="updateQuizVersions()">
    </select>
    <label>Select Quiz: </label>
    <select id="quizSelect">
    </select>
    <button onclick="loadQuiz()">Load Quiz</button>
    <button class="export" onclick="exportMappings()">Export Updated JSON</button>
  </div>

  <div id="problems"></div>
  
  <div id="output">
    <h2>Updated Quiz JSON</h2>
    <p>Copy this content and paste it into your quiz.json file:</p>
    <pre id="outputText"></pre>
  </div>

  <script>
    let appConfig = null;
    let currentSubject = null;
    let currentTestSet = null;
    let currentQuiz = null;
    let questions = [];
    let images = [];
    let mappings = {}; // questionIndex -> array of imageFilenames

    async function loadQuiz() {
      try {
        const quizIdx = parseInt(document.getElementById('quizSelect').value);
        currentQuiz = currentTestSet.quizVersions[quizIdx];
        
        // Load quiz.json
        const quizPath = `tests/${currentTestSet.quizPath}/${currentQuiz.name}/quiz.json`;
        console.log('Loading quiz from:', quizPath);
        
        const quizResponse = await fetch(quizPath);
        if (!quizResponse.ok) {
          throw new Error(`Failed to load quiz: ${quizResponse.status} ${quizResponse.statusText}`);
        }
        
        const quizData = await quizResponse.json();
        console.log('Quiz data loaded:', quizData);
        
        // Get questions array
        questions = quizData.questions || [];
        console.log(`Loaded ${questions.length} questions`);
        
        // Load available images
        images = await getAvailableImages(currentQuiz);
        console.log(`Found ${images.length} images`);
        
        // Initialize mappings from existing images (support both formats)
        questions.forEach((question, idx) => {
          const imagePaths = [];
          
          // Format 1: Check for "images" array property (Quiz 2 V1 format)
          if (question.images && Array.isArray(question.images)) {
            imagePaths.push(...question.images);
          }
          
          // Format 2: Check for [IMAGE:...] tags in question text (Quiz 2 V5 format)
          const imageMatches = question.question.matchAll(/\[IMAGE:([^\]]+)\]/g);
          for (const match of imageMatches) {
            // Store the full path from the IMAGE tag (e.g., "images/Quiz 2 V5-0.png")
            imagePaths.push(match[1]);
          }
          
          mappings[idx] = imagePaths;
          
          // Debug logging
          if (imagePaths.length > 0) {
            console.log(`Question ${question.number} (idx ${idx}): found image paths:`, imagePaths);
          }
        });
        
        renderQuestions();
      } catch (error) {
        console.error('Error loading quiz:', error);
        alert('Error loading quiz: ' + error.message);
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadConfig();
    });


    async function loadConfig() {
      try {
        const response = await fetch('config.json');
        appConfig = await response.json();
        populateSubjects();
      } catch (error) {
        console.error('Failed to load config:', error);
        alert('Failed to load configuration file');
      }
    }

    function populateSubjects() {
      const subjectSelect = document.getElementById('subjectSelect');
      subjectSelect.innerHTML = '';
      
      appConfig.subjects.forEach((subject, idx) => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        subjectSelect.appendChild(option);
      });
      
      updateTestSets();
    }

    function updateTestSets() {
      const subjectId = document.getElementById('subjectSelect').value;
      const subject = appConfig.subjects.find(s => s.id === subjectId);
      currentSubject = subject;
      
      const testSetSelect = document.getElementById('testSetSelect');
      testSetSelect.innerHTML = '';
      
      subject.testSets.forEach((testSet, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = testSet.name;
        testSetSelect.appendChild(option);
      });
      
      updateQuizVersions();
    }

    function updateQuizVersions() {
      const testSetIdx = parseInt(document.getElementById('testSetSelect').value);
      currentTestSet = currentSubject.testSets[testSetIdx];
      
      const quizSelect = document.getElementById('quizSelect');
      quizSelect.innerHTML = '';
      
      currentTestSet.quizVersions.forEach((quiz, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = quiz.name;
        quizSelect.appendChild(option);
      });
    }

    async function getAvailableImages(quiz) {
      const imageCount = quiz.imageCount;
      const images = [];
      
      for (let i = 0; i < imageCount; i++) {
        // Check both .png and .jpg
        const pngPath = `tests/${currentTestSet.quizPath}/${quiz.name}/images/${quiz.name}-${i}.png`;
        const jpgPath = `tests/${currentTestSet.quizPath}/${quiz.name}/images/${quiz.name}-${i}.jpg`;
        
        try {
          const response = await fetch(pngPath, { method: 'HEAD' });
          if (response.ok) {
            // Store as "images/Quiz 2 V5-0.png" to match JSON format
            const imagePath = `images/${quiz.name}-${i}.png`;
            images.push({ imagePath: imagePath, fullPath: pngPath });
            console.log(`Found image: ${imagePath}`);
            continue;
          }
        } catch (e) {}
        
        try {
          const response = await fetch(jpgPath, { method: 'HEAD' });
          if (response.ok) {
            // Store as "images/Quiz 2 V5-0.jpg" to match JSON format
            const imagePath = `images/${quiz.name}-${i}.jpg`;
            images.push({ imagePath: imagePath, fullPath: jpgPath });
            console.log(`Found image: ${imagePath}`);
          }
        } catch (e) {}
      }
      
      console.log('All available images:', images.map(i => i.imagePath));
      return images;
    }

    function renderQuestions() {
      const container = document.getElementById('problems');
      container.innerHTML = '';
      
      questions.forEach((question, idx) => {
        const div = document.createElement('div');
        div.className = 'problem-container';
        
        // Remove [IMAGE:...] tags from display
        const questionText = question.question.replace(/\[IMAGE:[^\]]+\]/g, '').trim();
        
        // Debug: log the comparison for each image
        console.log(`\n=== Rendering Question ${question.number} (idx ${idx}) ===`);
        console.log('Mappings for this question:', mappings[idx]);
        console.log('Mappings type:', typeof mappings[idx], 'Is array:', Array.isArray(mappings[idx]));
        if (mappings[idx]) {
          mappings[idx].forEach((m, i) => console.log(`  Mapping[${i}]: "${m}" (length: ${m.length})`));
        }
        console.log('Available images:', images.map(i => i.imagePath));
        images.forEach((img, i) => console.log(`  Image[${i}]: "${img.imagePath}" (length: ${img.imagePath.length})`));
        
        div.innerHTML = `
          <div class="problem-text">
            <h3>Question ${question.number} (${question.points} points)</h3>
            <pre>${questionText}</pre>
          </div>
          <div class="image-selector">
            <h4>Select Images:</h4>
            <div class="image-grid" id="imageGrid${idx}">
              ${images.map(img => {
                const isSelected = mappings[idx] && mappings[idx].includes(img.imagePath);
                console.log(`  Checking image "${img.imagePath}": selected=${isSelected}`);
                if (mappings[idx]) {
                  mappings[idx].forEach(m => {
                    console.log(`    Compare "${m}" === "${img.imagePath}": ${m === img.imagePath}`);
                  });
                }
                return `
                  <div class="image-option ${isSelected ? 'selected' : ''}" 
                       onclick="toggleImage(${idx}, '${img.imagePath}')">
                    <img src="${img.fullPath}" alt="${img.imagePath}">
                    <div class="label">${img.imagePath.split('/').pop().split('-').pop()}</div>
                    <div class="checkbox">${isSelected ? '‚úì' : ''}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function toggleImage(questionIdx, imagePath) {
      if (!mappings[questionIdx]) {
        mappings[questionIdx] = [];
      }
      
      const index = mappings[questionIdx].indexOf(imagePath);
      if (index > -1) {
        // Remove if already selected
        mappings[questionIdx].splice(index, 1);
      } else {
        // Add if not selected
        mappings[questionIdx].push(imagePath);
      }
      
      renderQuestions();
    }

    function exportMappings() {
      // Create a deep copy of the questions array
      const updatedQuestions = JSON.parse(JSON.stringify(questions));
      
      // Update each question with new image mappings
      updatedQuestions.forEach((question, idx) => {
        // Update the images array property (primary format)
        if (mappings[idx] && mappings[idx].length > 0) {
          question.images = mappings[idx];
        } else {
          // Remove images property if no images selected
          delete question.images;
        }
        
        // Also update [IMAGE:...] tags in question text for backward compatibility
        let questionText = question.question.replace(/\[IMAGE:[^\]]*\]/gi, '').trim();
        if (mappings[idx] && mappings[idx].length > 0) {
          const imageTags = mappings[idx].map(imgPath => `[IMAGE:${imgPath}]`).join(' ');
          questionText = questionText + ' ' + imageTags;
        }
        question.question = questionText;
      });
      
      // Create the full quiz JSON structure
      const quizData = {
        title: `PHYS 214 - Test 2, ${currentQuiz.name}`,
        questions: updatedQuestions
      };
      
      // Format as pretty JSON
      const output = JSON.stringify(quizData, null, 2);
      
      document.getElementById('outputText').textContent = output;
      document.getElementById('output').style.display = 'block';
      document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
    }

    // Removed automatic load - user must click "Load Quiz" button
  </script>
</body>
</html>
